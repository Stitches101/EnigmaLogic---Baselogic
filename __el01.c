
#include "__plugin.h"
#include "__el01.h"
#include "__el02.h"
#include "__el03.h"
#include <math.h>
#include "__serial.h"
#include "__schfer.h"
#include "variadef.h"
#include "__sock1.h"
#include <stdlib.h>

#include "__el02.c"
#include "__el03.c"
#include "__el01_1.c"
#include "__el02_1.c"
#include "__el03_1.c"
#include "__el04_1.c"
#include "__el09_1.c"


//**********************************************************************************************************************************************//
//Function Declarations
//**********************************************************************************************************************************************//
static void timeSwitch(BIT *in01, FL *in02, FL *in03,
	FL *ou01, FL *ou02, BIT *ou03,
	FL *x01, FL *x02, BIT *x03)//Memory
{
	//Initialization
	//**************************************************************************//
	if (PLUGIN_GetStartFlag())
	{
		*x02 = *in03;
		*x01 = 0;
	}
	//Calculation
	//**************************************************************************//
	if (*in01 == 1 && *x03 == 1)
	{
		*x02 = *in03;
		*x01 = 0;
	}
	else if (*in01 == 1 && *x03 == 0)
	{
		if (*x01 == *in02)
		{
			*x03 = 1;
			*x01 = 0;
		}
		if (*x01 > *in02)
		{
			*x03 = 1;
		}
		else
		{
			*x01 += 1;
		}
		if (*in01 == 1 && *x03 == 1)
		{
			*x01 = 0;
		}
	}

	else if (*in01 == 0 && *x03 == 1)
	{
		if (*x02 == 0)
		{
			*x03 = 0;
			*x02 = *in03;
		}
		else
		{
			*x02 -= 1;
		}
	}

	if (*in01 == 0 && *x03 == 0)
	{
		*x01 = 0;
	}
	if (*in01 == 1 && *x03 == 1)
	{
		*x02 = *in03;
	}

	//Set Output
	//**************************************************************************//
	*ou01 = *x01;
	*ou02 = *x02;
	*ou03 = *x03;

}

static void timeSwitch2(BIT *in01, ULI *in02, ULI *in03,
	ULI *ou01, ULI *ou02, BIT *ou03, BIT *ou04, BIT *ou05,
	ULI *x01, ULI *x02, BIT *x03)//Memory
{
	//Initialization
		//**************************************************************************//
	if (PLUGIN_GetStartFlag())
	{
		*x02 = *in03;
		*x01 = 0;
	}
	//Calculation
	//**************************************************************************//
	if (*in01 == 1 && *x03 == 1)
	{
		*x02 = *in03;
		*x01 = 0;
		*ou04 = 0;
		*ou05 = 0;
	}
	else if (*in01 == 1 && *x03 == 0)
	{
		if (*x01 == *in02)
		{
			*x03 = 1;
			*ou04 = 0;
			*ou05 = 0;
			*x01 = 0;
		}
		if (*x01 > *in02)
		{
			*x03 = 1;
			*ou04 = 0;
			*ou05 = 0;
		}
		else
		{
			*x01 += 1;
			*ou04 = 1;
		}
		if (*in01 == 1 && *x03 == 1)
		{
			*x01 = 0;
			*ou04 = 0;
			*ou05 = 0;
		}
	}
	else if (*in01 == 0 && *x03 == 1)
	{
		if (*x02 == 0)
		{
			*x03 = 0;
			*ou04 = 0;
			*ou05 = 0;
			*x02 = *in03;
		}
		else
		{
			*x02 -= 1;
			*ou05 = 1;
		}
	}
	if (*in01 == 0 && *x03 == 0)
	{
		*x01 = 0;
		*ou04 = 0;
		*ou05 = 0;
	}
	if (*in01 == 1 && *x03 == 1)
	{
		*x02 = *in03;
		*ou04 = 0;
		*ou05 = 0;
	}

	//Set Output
	//**************************************************************************//
	*ou01 = *x01;
	*ou02 = *x02;
	*ou03 = *x03;


}

static void timeSwitchBit(BIT *in01, FL *in02,
	BIT *ou01, BIT *ou02, FL *ou03, BIT *ou04,
	FL *x03, BIT *x01, BIT *x02, BIT *y02)//Memory
{
	//Main
	//**************************************************************************//
	if (*in01 == 1 && *x02 == 0 && *y02 == 0)

	{
		if (*x03 > 0)
		{
			*x03 -= 1;
			*x01 = 1;
		}
		else
		{
			*x03 = *in02;
			*x01 = 0;
			*y02 = 1;
		}

	}

	else if (*in01 == 0 && *x01 == 0 && *y02 == 1)
	{
		if (*x03 > 0)
		{
			*x03 -= 1;
			*x02 = 1;
		}
		else
		{
			*x03 = *in02;
			*x02 = 0;
			*y02 = 0;
		}
	}



	//Control 1
	//**************************************************************************//
	else if (*in01 == 0 && *x03 > 0 && *x03 != *in02)
	{
		*x03 -= 1;

		if (*x03 == 0)
		{
			*y02 = 1;
			*x01 = 0;
			*x02 = 0;
			*x03 = *in02;
		}
	}
	//Control 2
	//**************************************************************************//
	else if (*in01 == 1 && *x02 == 1 && *y02 == 1)
	{
		*x02 = 0;
		*x03 = *in02;
		*y02 = 0;
	}

	*ou01 = *x01;
	*ou02 = *x02;
	*ou03 = *x03;
	*ou04 = *y02;
}

static void timeSwitchBit2(BIT *in01, FL *in02,
	BIT *ou01, FL *ou03,
	FL *x01, BIT *x03)//Memory
{


	//Main
	//**************************************************************************//
	if (*in01 == 0 && *x03 == 1)
	{
		if (*x01 > 0)
		{
			*x01 -= 1;
			*x03 = 1;
		}
		else
		{
			*x01 = *in02;
			*x03 = 0;
		}
	}
	else if (*in01 == 1)
	{
		*x01 = *in02;
		*x03 = 1;
	}

	*ou01 = *x03;
	*ou03 = *x01;
}

static void timeSwitchBit3(BIT *in01, ULI *in02, BIT *in03,
	ULI *ou03, BIT *ou01,
	ULI *x01, BIT *x03)//Memory
{
	if (*in01 == 0 && *x03 == 0)
	{
		*x01 = 0;
	}
	if (*in01 == 1 && *x03 == 1)
	{
		*x01 = 0;
	}
	if (*in01 == 0 && *x03 == 1)
	{
		*x01 = 0;
	}
	if (*in01 == 1 && *x03 == 0)
	{
		if (*x01 == *in02)
		{
			*x03 = 1;
			*x01 = 0;
		}
		if (*x01 > *in02)
		{
			*x03 = 1;
			*x01 = 0;
		}
		else
		{
			*x01 += 1;
		}
		if (*in01 == 1 && *x03 == 1)
		{
			*x01 = 0;
		}
	}
	if (*in03 == 1)
	{
		*x03 = 0;
		*x01 = 0;
	}

	*ou01 = *x03;
	*ou03 = *x01;

}



static void statusOutput(BIT *in01, BIT *in02, BIT *in03, BIT *in04,
	FL *ou01,
	FL *x01)//Memory
{
	//Main
	//**************************************************************************//
	if (*in04 == 0)
	{
		*x01 = 4;
	}
	else if (*in03 == 1)
	{
		*x01 = 3;
	}
	else if (*in02 == 1 && *in01 == 1)
	{
		*x01 = 2;
	}
	else if (*in01 == 1)
	{
		*x01 = 1;
	}
	else
	{
		*x01 = 0;
	}
	*ou01 = *x01;


}

static void timeStamp(FL *in01, FL *in02, FL *in03,
	FL *ou01, FL *ou02, BIT *ou03,
	FL *x01, FL *x02, BIT *x03, BIT *x04)//Memory
{
	//Main
	//**************************************************************************//
	if (*in02 > *in01)
	{
		if (*x01 >= *in03 && *x03 == 0)
		{
			*x03 = 1;
			*x01 = *in03;
		}
		else if (*x01 < *in03)
		{
			*x01 += 1;
			*x03 = 0;
		}
		*x04 = 1;
	}
	else if (*in02 <= *in01 && *x04 == 1)
	{
		*x02 = *x01;
		*x04 = 0;
	}
	else
	{
		*x01 = 0;
		*x03 = 0;
	}

	*ou01 = *x01;
	*ou02 = *x02;
	*ou03 = *x03;
}

static void timeStampMaintenance(BIT *in01, ULI *in02,
	ULI *ou01,BIT *ou02,
	ULI *x01, BIT *x02)//Memory
{
	//Main
	//**************************************************************************//
	if (*in01 == 1)
	{
		if (*x01 >= *in02 && *x02 == 0)
		{
			*x02 = 1;
			*x01 = 0;
		}
		else if (*x01 < *in02)
		{
			*x01 += 1;
			*x02 = 0;
		}
	}
	else
	{
		*x01 += 0;
	}


	*ou01 = *x01;
	*ou02 = *x02;
}

static void loopSwitch(BIT *in01, FL *in02, FL *in03, BIT *in04,
	FL *ou01, FL *ou02, BIT *ou03,
	FL *x01, FL *x02, BIT *x03, BIT *x04)//Memory
{
	//Calculation
	//**************************************************************************//
	if (*in04 == 0)
	{
		*x01 = 0;
		*x02 = *in03;
	}
	else
	{

		if (*in01 == 1 && x03 == 0)
		{
			if (*x01 == *in02)
			{
				*x03 = 1;
				*x01 = 0;
			}
			if (*x01 > *in02)
			{
				*x03 = 1;
			}
			else
			{
				*x01 += 1;
			}
			if (*in01 == 1 && *x03 == 1)
			{
				*x01 = 0;
			}
		}
		else if (*in01 == 1 && *x03 == 1)
		{
			if (*x02 == 0)
			{
				*x03 = 0;
				*x02 = *in03;
			}
			else
			{
				*x02 -= 1;
			}
		}
		if (*in01 == 0 && *x03 == 0)
		{
			*x01 = 0;
		}
		if (*in01 == 0 && *x03 == 1)
		{
			*x02 = *in03;
		}
	}

	//Set Output
	//**************************************************************************//
	*ou01 = *x01;
	*ou02 = *x02;
	*ou03 = *x03;



}

static void twoRamp(FL *in01, FL *in02, FL *in03, FL *in04, FL *in05, FL *in06,
	FL *ou01, FL *ou02,
	FL *x08)//Memory

{

	//Variable Local
	//**************************************************************************//
	FL x01 = 0, x02 = 0, x03 = 0, x04 = 0, x05 = 0;

	//Initialization
	//**************************************************************************//
	if (PLUGIN_GetStartFlag())
	{
		x01 = 0, x02 = 0, x03 = 0, x04 = 0, x05 = 0;
		*in01 = 0, *in02 = 0, *in03 = 0, *in04 = 0, *in05 = 0, *in06 = 0,
			*ou01 = 0, *ou02 = 0,
			*x08 = 0;
	}
	

	//Calculation
	//**************************************************************************//
	x01 = (*in05 - *in03);
	x02 = (*in04 - *in06);
	x03 = (x02 / x01);
	x04 = (*in01 - *in03);
	x05 = (*in04 - (x04 * x03));

	if (*in04 == *in06)
	{
		x05 = 0;
	}

	//Min Max
	//**************************************************************************//
	else if (*in04 > *in06)
	{
		if (x05 >= *in04)
		{
			x05 = *in04;
		}

		if (x05 <= *in06)
		{
			x05 = *in06;
		}
	}

	else if (*in06 > *in04)
	{
		if (x05 <= *in04)
		{
			x05 = *in04;
		}

		if (x05 >= *in06)
		{
			x05 = *in06;
		}

	}

	//Follow Output
	//**************************************************************************//

	if (*x08 < x05)
	{
		if (*x08 + *in02 > x05)
		{
			*x08 = x05;
		}
		else
		{
			*x08 += *in02;
		}
	}

	if (*x08 > x05)
	{
		if (*x08 - *in02 < x05)
		{
			*x08 = x05;
		}
		else
		{
			*x08 -= *in02;
		}
	}

	//Set Output
	//**************************************************************************//
	*ou01 = x05;
	*ou02 = *x08;
}
static void threeRamp(FL *in01, FL *in02, FL *in03, FL *in04, FL *in05, FL *in06, FL *in07, FL *in08,
	FL *ou01, FL *ou02,
	FL *x06)// Memory
{
	//Variable Local
	//**************************************************************************//
	FL x01 = 0, x02 = 0, x03 = 0, x04 = 0, x05 = 0, x07 = 0, x08 = 0, x09 = 0, x10 = 0;

	//Initialization
	//**************************************************************************//
	if (PLUGIN_GetStartFlag())
	{
		x01 = 0, x02 = 0, x03 = 0, x04 = 0, x05 = 0, x07 = 0, x08 = 0, x09 = 0, x10 = 0;
		*in01 = 0, *in02 = 0, *in03 = 0, *in04 = 0, *in05 = 0, *in06 = 0, *in07 = 0, *in08 = 0,
			*ou01 = 0, *ou02 = 0,
			*x06 = 0;
	}
	
	//Calculation
	//**************************************************************************//
	x01 = (*in05 - *in03);
	x02 = (*in04 - *in06);
	x03 = (x02 / x01);
	x04 = (*in01 - *in03);

	x07 = (*in07 - *in05);
	x08 = (*in06 - *in08);
	x09 = (x08 / x07);
	x10 = (*in01 - *in07);

	if (*in01 == *in05)
	{
		x05 = *in06;
	}
	else if (*in04 > *in08 && *in01 < *in05)
	{
		if (*in03 > *in07)
		{
			x05 = (*in08 - (x10 * x09));
		}
		else
		{
			x05 = (*in04 - (x04 * x03));
		}
	}
	else if (*in04 > *in08 && *in01 > *in05)
	{
		if (*in03 > *in07)
		{
			x05 = (*in04 - (x04 * x03));
		}
		else
		{
			x05 = (*in08 - (x10 * x09));
		}
	}

	else if (*in04 < *in08 && *in01 < *in05)
	{
		if (*in03 > *in07)
		{
			x05 = (*in08 - (x10 * x09));
		}
		else
		{
			x05 = (*in04 - (x04 * x03));
		}
	}
	else if (*in04 < *in08 && *in01 > *in05)
	{
		if (*in03 > *in07)
		{
			x05 = (*in04 - (x04 * x03));
		}
		else
		{
			x05 = (*in08 - (x10 * x09));
		}
	}
	else
	{
		x05 = 0;
	}

	//Min Max
	//**************************************************************************//
	if (*in04 == *in06 || *in04 == *in08)
	{
		x05 = 0;
	}
	else if (*in04 > *in08)
	{
		if (x05 >= *in04)
		{
			x05 = *in04;
		}

		if (x05 <= *in08)
		{
			x05 = *in08;
		}
	}
	else if (*in08 > *in04)
	{
		if (x05 <= *in04)
		{
			x05 = *in04;
		}

		if (x05 >= *in08)
		{
			x05 = *in08;
		}

	}
	//Follow Output
	//**************************************************************************//
	if (*x06 < x05)
	{
		if (*x06 + *in02 > x05)
		{
			*x06 = x05;
		}
		else
		{
			*x06 += *in02;
		}
	}

	if (*x06 > x05)
	{
		if (*x06 - *in02 < x05)
		{
			*x06 = x05;
		}
		else
		{
			*x06 -= *in02;
		}
	}

	//Set Output
	//**************************************************************************//
	*ou01 = x05;
	*ou02 = *x06;

}

static void proportionalIntegrator(FL *in01, FL *in02, FL *in03, FL *in04, FL *in05, FL *in06, BIT *in07, FL *in08, FL *in09,
	FL *ou01, FL *ou02, FL *ou03, FL *ou04, FL *ou05, FL *ou06, FL *ou07, FL *ou08, FL *ou09, FL *ou10, FL *ou11,
	FL *x12, FL *x13, FL *x15)// Memory
{

	//Variable Local
	//**************************************************************************//
	FL x01 = 0, x02 = 0, x03 = 0, x04 = 0, x05 = 0, x06 = 0, x07 = 0, x08 = 0, x09 = 0, x10 = 0, x14 = 0;

	//Initialization
	//**************************************************************************//
	if (PLUGIN_GetStartFlag())
	{
		x01 = 0, x02 = 0, x03 = 0, x04 = 0, x05 = 0, x06 = 0, x07 = 0, x08 = 0, x09 = 0, x10 = 0, x14 = 0;
		*in01 = 0, *in02 = 0, *in03 = 0, *in04 = 0, *in05 = 0, *in06 = 0, *in07 = 0, *in08 = 0, *in09 = 0;
			*ou01 = 0, *ou02 = 0, *ou03 = 0, *ou04 = 0, *ou05 = 0, *ou06 = 0, *ou07 = 0, *ou08 = 0, *ou09 = 0, *ou10 = 0, *ou11 = 0,
			*x12 = 0, *x13 = 0, *x15 = 0;
	}
	//Conditions
	//**************************************************************************//
	if (*in07 == 0)
	{
		*ou01 = 0;
		*ou02 = 0;
		*ou03 = 0;
		*ou04 = 0;
		*ou05 = 0;
		*ou06 = 0;
		*ou07 = 0;
		*ou08 = 0;
		*ou09 = 0;
		*ou10 = 0;
		*ou11 = 0;
	}
	else
	{
		//P Calculation
		//**************************************************************************//

		x01 = *in05 * 3.3;
		x02 = 1 / (*in05 / *in06);
		x03 = *in03 - (0.5 * *in04);
		x04 = *in01 - x03;
		x05 = x04 * (1 / (1 + x02));
		x06 = *in04 / x02;
		x07 = *in05 / *in06;
		x08 = ((0.5 * x06) - x05)*(100 / x06);
		x09 = x06 * 1.1;
		x10 = ((0.5 * x09) - x05)*(100 / x09);
		x14 = (x10 / x01);

		//i action
		//**************************************************************************//
		if (*in03 < *in01)
		{
			*x12 -= x14;
		}
		else
		{
			*x12 += x14;
		}
		

		//Min Max
		//**************************************************************************//
		if (x08 > *in08)
		{
			x08 = *in08;
		}
		else if (x08 < *in09)
		{
			x08 = *in09;
		}

		if (*x12 > *in08)
		{
			*x12 = *in08;
		}
		else if (*x12 < *in09)
		{
			*x12 = *in09;
		}

		//Slow Output
		//**************************************************************************//
		if (*x13 < *x12)
		{
			if (*x13 + *in02 > *x12)
			{
				*x13 = *x12;
			}
			else
			{
				*x13 += *in02;
			}
		}

		else if (*x13 > *x12)
		{
			if (*x13 - *in02 < *x12)
			{
				*x13 = *x12;
			}
			else
			{
				*x13 -= *in02;
			}
		}
		//Set Output
		//**************************************************************************//
		*ou01 = x01;
		*ou02 = x02;
		*ou03 = x03;
		*ou04 = x04;
		*ou05 = x05;
		*ou06 = x06;
		*ou07 = x07;
		*ou08 = x08;  //p action
		*ou09 = *x12;  //pi action problem 
		*ou10 = *x13; //slow output
		*ou11 = x14;  //step i action
	}
}

static void proportionalIntegratorEL(FL *in01, FL *in02, FL *in03,
	FL *ou01,
	FL *x12, FL *x13, FL *x15, FL *x17)// Memory
{

	//Variable Local
	//**************************************************************************//
	FL x01 = 0, x02 = 0, x03 = 0, x04 = 0, x05 = 0, x06 = 0, x07 = 0, x08 = 0, x09 = 0, x10 = 0, x14 = 0, x16 = 0;
	FL flow = 0;
	FL procesPower = 0;
	FL procesSetpoint = 0;
	FL timeWait = 0;
	FL timeAdjust = 0;
	FL grmin = 0;
	FL grmax= 0;
	FL nu01 = 0;
	//Initialization
//**************************************************************************//
	if (PLUGIN_GetStartFlag())
	{
		x01 = 0, x02 = 0, x03 = 0, x04 = 0, x05 = 0, x06 = 0, x07 = 0, x08 = 0, x09 = 0, x10 = 0, x14 = 0, x16 = 0;
		*in01 = 0, *in02 = 0, *in03 = 0,
			*ou01 = 0,
			*x12 = 0, *x13 = 0, *x15 = 0, *x17 = 0;
		flow = 0, procesPower = 0, procesSetpoint = 0, timeWait = 0, timeAdjust = 0, grmin = 0, grmax = 0, nu01 = 0;
	}
	//Conditions
	//**************************************************************************//
	if (*in03 == 0)
	{
		*ou01 = 0;
	}
	else
	{
		//P Calculation
		//**************************************************************************//
		flow = 0.01;
		procesPower = 100;
		procesSetpoint = 50;
		timeWait = 200;
		timeAdjust = 1000;

		x01 = timeWait * 3.3;
		x02 = 1 / (timeWait / timeAdjust);
		x03 = procesSetpoint - (0.5 * procesPower);
		x04 = *in01 - x03;
		x05 = x04 * (1 / (1 + x02));
		x06 = procesPower / x02;
		x07 = timeWait / timeAdjust;
		x08 = ((0.5 * x06) - x05)*(100 / x06);
		x09 = x06 * 1.1;
		x10 = ((0.5 * x09) - x05)*(100 / x09);
		x14 = (x10 / x01);

		//i action
		//**************************************************************************//

		*x12 += x14;

		//Min Max
		//**************************************************************************//
		if (x08 > 100)
		{
			x08 = 100;
		}
		else if (x08 < 0)
		{
			x08 = 0;
		}

		if (*x12 > 100)
		{
			*x12 = 100;
		}
		else if (*x12 < 0)
		{
			*x12 = 0;
		}

		//Slow Output
		//**************************************************************************//
		if (*x13 < *x12)
		{
			if (*x13 + *in02 > *x12)
			{
				*x13 = *x12;
			}
			else
			{
				*x13 += *in02;
			}
		}

		else if (*x13 > *x12)
		{
			if (*x13 - *in02 < *x12)
			{
				*x13 = *x12;
			}
			else
			{
				*x13 -= *in02;
			}
		}

		grmin = 0;
		grmax = 100;
		twoRamp(&*x13, &flow, &grmin, &*in02, &grmax, &*in03, &nu01, &x16, &*x17);//max

		//Set Output
		//**************************************************************************//
		*ou01 = x16; //slow output
	}
}

static void flowOutput(FL *in01, FL *in02,
	FL *ou01,
	FL *x01)//Memory
{

	//Follow Output
	//**************************************************************************//

	if (*x01 < *in01)
	{
		if (*x01 + *in02 > *in01)
		{
			*x01 = *in01;
		}
		else
		{
			*x01 += *in02;
		}
	}

	if (*x01 > *in01)
	{
		if (*x01 - *in02 < *in01)
		{
			*x01 = *in01;
		}
		else
		{
			*x01 -= *in02;
		}
	}

	//Set Output
	//**************************************************************************//
	*ou01 = *x01;
}



















